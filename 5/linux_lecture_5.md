## Розділ 5: Диски та файлові системи
Розділи — це логічні частини всього диска, в Linux вони позначаються числом після цілого блочного пристрою.

Ядро представляє кожен розділ як блоковий пристрій, як і весь диск. Розділи записуються на невеликій ділянці диска, яка називається таблицею розділів.

![Типова схема диску Linux](images/Figure4-1.png)

Наступним рівнем після розділу є файлова система, база даних файлів і каталогів, до яких ви звикли для взаємодії в просторі користувача.

![Доступ до диску](images/Figure4-2.png)

### Розбиття дискових пристроїв
Існує багато видів таблиць розділів. Традиційна таблиця – це та, що міститься в головному завантажувальному записі (Master Boot Record -- MBR).

Новішим стандартом є таблиця розділення глобальних унікальних ідентифікаторів (Globally Unique Identifier Partition Table -- GPT). Ось деякі інструменти для роботи з розділами Linux:

     * parted: текстовий інструмент, який підтримує як MBR, так і GPT
     * gparted: графічна версія parted
     * fdisk: традиційний текстовий інструмент розбиття диска Linux. fdisk не підтримує GPT
     * gdisk: версія fdisk, яка підтримує GPT, але не підтримує MBR

Короткий огляд роботи з  parted:

1. Виведення таблиці розділів

     ```
     sudo parted /dev/sda print
     ```

2. Створення новогу розділу

     ```
     sudo parted /dev/sda mkpart primary ext4 1MiB 500MiB
     ```

3. Видалення розділу

     ```
     sudo parted /dev/sda rm 1
     ```

4. Зміна розміру розділу

     ```
     sudo parted /dev/sda resize 1 1GiB
     ```

![Робота з parted](images/parted.png)

#### Перегляд таблиці розділів
Ви можете переглянути таблицю розділів вашої системи за допомогою parted -l. Розділ MBR може бути основного, розширеного та логічного типу (primary, extended, logical). Основний розділ — це звичайний підрозділ диска.

Базова таблиця MBR обмежена чотирма основними розділами, тому, якщо вам потрібно більше чотирьох, ви призначаєте один розділ як розширений.

#### Зміна таблиць розділів
Зміна таблиці розділів ускладнює відновлення будь-яких даних на розділах, які ви видаляєте, оскільки це змінює початкову точку відліку для файлової системи, вам потрібно переконатися, що жоден розділ на вашому цільовому диску не  використовується.

Для створення розділів можна використовувати різні інструменти, наприклад _parted_, _gparted_, _gdisk_ або _fdisk_. _fdisk_ і _parted_ змінюють розділи повністю в просторі користувача.

#### Геометрія диска та розділу
Диск складається з пластини, що обертається на шпинделі, з головкою, прикріпленою до рухомої руки, яка може обертатися по радіусу диска.

![Жорсткий диск](images/Figure4-3.png)

Навіть якщо ви можете уявити собі жорсткий диск як блоковий пристрій із довільним доступом до будь-якого блоку, потенційно можливі серйозні наслідки для продуктивності, якщо ви не будете уважні до того, як ви розміщуєте дані на диску.

#### Твердотільні диски (SSD)
У твердотільні дисках (SSD) довільний доступ не є проблемою, оскільки немає головки, щоб пронести по диску, але деякі міркування все ще релевантні.

Наприклад, _вирівнювання розділів_ (дані зчитуються блоками фіксованого розміру, якщо дані розміщені у двох блоках, вам потрібно виконати два читання, навіть якщо обсяг даних для читання менший за розмір блоку).

### Файлові системи
Файлова система є формою бази даних; вона забезпечує структуру для перетворення простого блокового пристрою в складну ієрархію файлів і підкаталогів, зрозумілу користувачам.

Файлові системи також традиційно реалізуються в ядрі, але існують також файлові системи в просторі користувача (FUSE) і віртуальні файлові системи (VFS).

#### Типи файлової системи
Це найпоширеніші типи файлових систем для зберігання даних. Назви типів, які розпізнає Linux, у круглих дужках поруч із назвами файлових систем:

     * Четверта розширена файлова система (ext4): поточна ітерація лінії файлових систем, рідних для Linux
     * ISO 9660 (iso9660): це стандарт CD-ROM (більшість CD-ROM використовують деякі варіанти стандарту ISO 9660)
     * Файлові системи FAT (msdos, vfat, umsdos): відносяться до систем Microsoft. Більшість сучасних файлових систем Windows використовують файлову систему vfat для отримання повного доступу з Linux
     * HFS+ (hfsplus): стандарт Apple, який використовується в більшості систем Macintosh
    
#### Створення файлової системи
Щоб створити файлову систему, як і у випадку з розділенням, ви зробите це в просторі користувача, оскільки процес простору користувача може безпосередньо отримувати доступ до блокового пристрою та керувати ним.

Утиліта _mkfs_ може створювати багато видів файлових систем:

```bash
# creates an ext4 filesystem
mkfs -t ext4 /dev/sdf2 
```

_mkfs_ — це лише інтерфейс для серії програм створення файлової системи, mkfs.fs, де fs — тип файлової системи.

Отже, коли ви запускаєте mkfs -t ext4, mkfs, у свою чергу, запускає mkfs.ext4, розташований у _/sbin/mkfs.\*_

#### Монтування файлової системи
Процес підключення файлової системи називається монтуванням. Коли система завантажується, ядро зчитує деякі конфігураційні дані та монтує кореневий каталог (/) на основі конфігураційних даних. Щоб підключити файлову систему, ви повинні знати наступне:
    
     * Пристрій файлової системи (де зберігаються фактичні дані файлової системи)
     * Тип файлової системи
     * Точка монтування — це: місце в ієрархії каталогів поточної системи, куди буде приєднано файлову систему
    
```bash
# The format of the command is: mount -t type device mountpoint
mount -t ext4 /dev/sdf2 /home/extra
```

#### UUID файлової системи
Імена пристроїв можуть змінюватися, оскільки вони залежать від порядку, у якому ядро знаходить пристрої. Щоб вирішити цю проблему, ви можете визначити та змонтувати файлові системи за їхнім універсальним унікальним ідентифікатором (UUID), програмним стандартом.

Щоб переглянути список пристроїв і відповідні файлові системи та UUID у вашій системі, скористайтеся програмою _blkid_.

Щоб змонтувати файлову систему за її UUID, використовуйте `mount UUID=<uuid> <Mount point>`

#### Буферизація диска, кешування та файлові системи
Буфери Unix записують на диск, коли ви демонтуєте файлову систему за допомогою umount, ядро автоматично синхронізується з диском.

Ви можете змусити ядро записати зміни у своєму буфері на диск, виконавши команду _sync_.

#### Параметри монтування файлової системи
Деякі важливі параметри команди монтування:

     * -t: вказати тип файлової системи
     * -r: монтувати файлову систему в режимі лише для читання
     * -n: щоб переконатися, що монтування не намагається оновити базу даних монтування системи (/etc/mtab)
     * -o: активувати опцію файлової системи (-o <параметр>). Деякі з цих варіантів:
         * exec, noexec: вмикає або вимикає виконання програм у файловій системі
         * suid, nosuid: вмикає або вимикає програми setuid
         * ro Монтує файлову систему в режимі лише для читання (як і короткий параметр -r)
         * rw Монтує файлову систему в режимі читання-запису
         * conv=rule (файлові системи на основі FAT) Перетворює символи нового рядка у файлах на основі певних правил.

#### Перемонтування файлової системи
Щоб повторно підключити поточну змонтовану файлову систему до тієї самої точки монтування з іншими параметрами монтування, виконайте такі дії

`mount <options> -o remount <mounting point>`

#### Таблиця файлової системи /etc/fstab
Системи Linux зберігають постійний список файлових систем і параметрів у _/etc/fstab_. Кожен рядок описує файлову систему з такими полями:

     * Пристрій або UUID
     * Точка монтування -- вказує, куди підключили файлову систему
     * Тип файлової системи
     * Параметри, розділені комами
     * Інформація про резервне копіювання для використання командою dump
     * Порядок перевірки цілісності файлової системи

#### Альтернативи /etc/fstab
Альтернативою файлу _/etc/fstab_ є каталог _/etc/fstab.d_, який містить окремі файли конфігурації файлової системи та для налаштування одиниць _systemd_ для файлових систем.

#### Ємність файлової системи
Щоб переглянути розмір і використання поточних змонтованих файлових систем, скористайтеся командою _df_. Вихід містить:

     * Filesystem: пристрій файлової системи
     * 1024-blocks: загальна ємність файлової системи в блоках по 1024 байта
     * Used: кількість зайнятих блоків
     * Available: кількість безкоштовних блоків
     * Capacity: відсоток використовуваних блоків
     * Mounted on: точці монтування
    
Якщо ваш диск заповнений і вам потрібно знати, де виділено місце, скористайтеся командою _du_.

#### Перевірка та відновлення файлових систем
Якщо у змонтованій файловій системі є помилки, це може призвести до втрати даних і збою системи. Інструментом для перевірки файлової системи є _fsck_

Існують різні версії `fsck` для кожного типу файлової системи, яку підтримує Linux.

Щоб запустити `fsck` в інтерактивному ручному режимі (-n для автоматичного режиму), укажіть пристрій або точку монтування (як зазначено в /etc/fstab) як аргумент:

```bash
fsck /dev/sdb1
```

##### Перевірка файлових систем ext3 і ext4
Ви можете змонтувати несправну файлову систему ext3 або ext4 у режимі ext2, оскільки ядро не монтуватиме файлову систему ext3 або ext4 із непорожнім журналом.

Щоб скинути журнал із файлової системи ext3 або ext4 до звичайної бази даних файлової системи, запустіть e2fsck так: `e2fsck –fy /dev/disk_device`
 
##### Найгірший випадок
Інструмент `debugfs` дозволяє вам переглядати файли у файловій системі та копіювати їх в інше місце.

#### Файлові системи спеціального призначення
Більшість версій Unix мають файлові системи, які служать системними інтерфейсами. Тобто замість того, щоб служити лише засобом для зберігання даних на пристрої, файлова система може представляти системну інформацію, таку як ідентифікатори процесу та діагностику ядра.

Спеціальні типи файлових систем, які зазвичай використовуються в Linux, включають наступне:

     * proc: змонтовано до /proc. Кожен пронумерований каталог у /proc є ідентифікатором поточного процесу в системі.
     Файл /proc/self представляє поточний процес
     * sysfs: змонтовано до /sys
     * tmpfs монтується в /run та в інших місцях. tmpfs дозволяє використовувати фізичну пам'ять і простір підкачки як тимчасове сховище
    
### Swap
Якщо у вас вичерпано реальну пам’ять, система віртуальної пам’яті Linux може автоматично переміщувати частини пам’яті на дискове сховище та з нього (свопінг). 

Область диска, яка використовується для зберігання сторінок пам’яті, називається простором підкачки (для перегляду поточної статистики пам'ятті використовуйте команду _free_).
 
#### Використання розділу диска як місця підкачки
Щоб використовувати весь розділ диска як своп, переконайтеся, що розділ порожній, і запустіть `mkswap dev`, де `dev` — це пристрій розділу. Потім виконайте `swapon dev`, щоб зареєструвати простір у ядрі.

#### Використання файлу як місця підкачки
Використовуйте ці команди, щоб створити порожній файл, ініціалізувати його як простір свопу та додати до пулу підкачки:

```bash
dd if=/dev/zero of=<the swap file> bs=1024k count=<desired size in mb> 
mkswap <the swap file>
swapon <the swap file>
```

#### Скільки свопу вам потрібно?
Загальноприйнята думка Unix говорить, що ви завжди повинні резервувати принаймні вдвічі більше, ніж у вас є реальна пам’ять.

#### Всередині традиційної файлової системи
Традиційна файлова система Unix має два основні компоненти: пул блоків даних, де ви можете зберігати дані, і систему бази даних, яка керує пулом даних. База даних зосереджена навколо структури даних _inode_.

_inode_ — це набір даних, який описує певний файл, включаючи його тип, дозволи та місце розташування даних файлу в пулі даних. _inode_ ідентифікуються номерами, зазначеними в таблиці _inode_.

![Файлова система на рівні користувача](images/Figure4-4.png)

![Дескриптори файлової системи](images/Figure4-5.png)

#### Перегляд деталей Inode
Щоб переглянути номери _inode_ для будь-якого каталогу, скористайтеся командою `ls -i`. Щоб отримати детальнішу інформацію про _inode_, використовуйте команду _stat_.

### Менеджер логічних томів LVM

Менеджер логічних томів (LVM) — це шар абстракції, який дозволяє вам створювати віртуальні томи, які можуть бути більшими, ніж фізичні пристрої, і змінювати розмір віртуальних томів без перезавантаження системи.

Ви створюєте набір фізичних томів (Physical Volumes -- PV), які ви об'єднуєте в групу фізичних томів (Volume Group -- VG), а потім ви вибираєте частину цього об'єднання для створення логічних томів (Logical Volumes -- LV).

![Менеджер логічних томів](images/lvm.png)

Логічні тома -- це просто блочні пристрої, які мають власні файлові системи, які ви можете монтувати та використовувати як будь-який інший блоковий пристрій. Це схоже на розділення диска, але з додатковими можливостями.

LVM дозволяє виконувати наступні задачі:

     * Додавати більше фізичних томів до групи, щоб збільшити її обсяг
     * Видаляти фізичні томи з групи, якщо група має достатньо місця для розміщення даних
     * Змінювати розмір логічних томів без перезавантаження системи

Менеджер LVM часто використовується в хмарних середовищах, де він дає необхідну гнучкість для розміщення віртуальних машин.

#### Робота з менеджером LVM

Більшість інструментів lvm побудовані на загальній команді _lvm_, яка викликає інтерактивний оболонковий інтерфейс. Ви можете використовувати команди _pv*, vg*, lv*_ для роботи з фізичними томами, групами фізичних томів та логічними томами відповідно. Наприклад, команда _vgs_ має той самий ефект, що й введення _vgs_ в інтерактивному режимі _lvm_.

#### Групи томів та їх перелік

Група томів — це набір фізичних томів, які об'єднуються разом, щоб створити великий пул даних. 

Щоб переглянути список груп томів, скористайтеся командою _vgs_.

![Групи томів](images/vgs.png)

Вивід команди має наступні поля:

     * VG: ім'я групи томів
     * #PV: кількість фізичних томів у групі
     * #LV: кількість логічних томів у групі
     * #SN: кількість фізичних томів, які можуть бути додані до групи
     * Attr: атрибути групи томів
     * VSize: загальний розмір групи томів
     * VFree: кількість вільного місця в групі томів

Для більш детальної інформації про групу томів використовуйте команду _vgdisplay_.

#### Перелік логічних томів

Щоб переглянути список логічних томів, скористайтеся командою _lvs_ (або _lvdisplay_ для більш детальної інформації).

![Логічні томи](images/lvs.png)

Головними в виводі є наступні стовпці:

     * LV: ім'я логічного тому
     * VG: ім'я групи томів, до якої він належить
     * Attr: атрибути логічного тому
     * LSize: розмір логічного тому

#### Пристрої логічних томів

Пристрої з блоками даних логічних томів зазвичай знаходяться за адресами _/dev/dm-*_, де _*_ — це номер логічного тому. Через випадковий порядок надання пристроїв, ви не можете визначити, який пристрій відповідає якому логічному тому, тому LVM створює символьні посилання на ці пристрої у каталозі _/dev/vg_name/lv_name_.

Також в дистрибутивах часто є додаткове місце для символічних посилань на пристрої логічних томів у каталозі _/dev/mapper_. Формат іменування тут — _/dev/mapper/vg_name-lv_name_.

Саме посилання в _/dev/mapper_ варто використовувати для монтування логічних томів.

#### Перелік фізичних томів

Щоб переглянути список фізичних томів, скористайтеся командою _pvs_ (або _pvdisplay_ для більш детальної інформації).

![Фізичні томи](images/pvs.png)

Головними в виводі є наступні стовпці:

     * PV: ім'я фізичного тому
     * VG: ім'я групи томів, до якої він належить
     * Fmt: формат фізичного тому
     * Attr: атрибути фізичного тому
     * PSize: розмір фізичного тому
     * PFree: кількість вільного місця в фізичному томі

За допомогою фізичних томів створюються групи томів, які використовуються для створення логічних томів. Кожен фізичний том, крім імені блочного пристрою, має ще метадані (_physical volume metadata_), які вказують, чи він використовується в групі томів, та інші атрибути.

### Побудова системи логічних томів

#### Створення групи томів

Щоб створити групу томів, використовуйте команду _vgcreate_, вказавши ім'я групи томів та принаймні один фізичний том.

```bash
vgcreate vg_name /dev/sdb1
```

![Створення групи томів](images/vgcreate.png)

Ви також можете створити фізичний том самостійно, використовуючи команду _pvcreate_. Однак це необхідно лише в тому випадку, якщо ви хочете використовувати фізичний том, який вже містить дані.

В іншому випадку, якщо ви хочете використовувати весь пристрій, ви можете вказати його ім'я у команді _vgcreate_, і LVM автоматично створить фізичний том.

Після створення групи томів ви можете переглянути її за допомогою команди _vgs_. Якщо група не відображається, можете використати команду _pvscan_ для оновлення списку груп томів.

Після цього можна додати до групи томів новий фізичний том, використовуючи команду _vgextend_.

![Розширення групи томів](images/vgextend.png)

#### Створення логічних томів

Щоб створити логічний том, використовуйте команду _lvcreate_, вказавши ім'я групи томів, розмір логічного тому та ім'я логічного тому.

![Створення логічного тому](images/lvcreate.png)

Для вказання розміру в байтах треба використовувати ключ _--size_, а для вказання розміру в фізичних екстентах — ключ _--extents_. Фізичний екстент — це найменша одиниця розміру, яку можна використовувати для створення логічних томів, рівна 4 МБ за замовчуванням.

_--type linear_ є найпростішим типом логічного тому, який використовує простий лінійний метод розміщення даних на фізичних томах. Він використовується за замовчуванням, тому його можна опускати.

#### Створення розділів файлової системи на логічних томах

Після створення логічного тому ви можете створити на ньому файлову систему, використовуючи команду _mkfs_, як і для звичайного розділу.

![Створення файлової системи](images/lvm_mkfs.png)

#### Видалення логічних томів

Якщо ви з'ясували, що один з фізичних томів виявився непотрібним, ви можете видалити логічний том, використовуючи команду _lvremove_.

![Видалення логічного тому](images/lvremove.png)

Якщо не вказати слеш, то команда _lvremove_ спробує видалити всі тома в групі томів.

#### Зміна розміру логічних томів

Ви можете змінити розмір логічного тому, використовуючи команду _lvresize_ навіть коли він використовується. Це дозволяє вам збільшити розмір логічного тому, якщо ви виявите, що він занадто малий.

Загалом, ви маєте змінити розмір як логічного тому, так і файлової системи, яка знаходиться на ньому. Однак утиліта _lvresize_ може зробити це за вас, якщо ви вказали ключ _-r_.

```
# lvresize -r -l +100%FREE myvg/mylv1
```

![Зміна розміру логічного тому](images/lvresize.png)

![Зміна розміру файлової системи](images/fsadm.png)

_fsadm_ — це, грубо кажучи, набір сценаріїв для дій з файловими системами. Наприклад, він може викликати інструмент _resize2fs_ для зміни розміру файлової системи.

Збільшити розмір файлової системи _ext2/3/4_ можна, коли вона змонтована, але зменшити — ні. Щоб зменшити розмір файлової системи, вона повинна бути розмонтована.