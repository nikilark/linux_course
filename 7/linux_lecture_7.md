# Розділ 7: Пристрої в Linux

## Файли пристроїв

Більшість пристроїв у системі Unix доступні через спеціальні файли, оскільки ядро представляє багато інтерфейсів вводу/виводу пристроїв для процесів користувача у вигляді файлів.

З деякими пристроями можна взаємодіяти за допомогою стандартних програм, таких як `cat`, хоча не всі пристрої чи можливості пристроїв доступні за допомогою стандартного файлового введення/виведення.

![Пристрої в Linux](images/ls_dev.png)

Якщо ви перерахуєте вміст `/dev`, перша відображена літера вкаже вам тип пристрою:

- Блоковий пристрій (`b`): Програми отримують доступ до даних із блокового пристрою фіксованими фрагментами (наприклад як дискові пристрої)
- Символьний пристрій (`c`): працює з потоками даних. Ви можете лише читати/записувати символи з/на символьні пристрої.

    Символьні пристрої не мають розміру; коли ви читаєте або записуєте в один з них, ядро зазвичай виконує операцію читання або запису на пристрої (як принтери). Під час взаємодії з символьним пристроєм ядро не може створити резервну копію та повторно перевірити потік даних після того, як воно передало дані на пристрій або процес

- Пристрої конвеєра (`pipe`) (`p`): схожі на символьні пристрої, з іншим процесом на іншому кінці потоку введення-виведення замість драйвера ядра
- Socket (`s`): інтерфейс спеціального призначення, який часто використовуються для  зв’язку між процесами

## Шлях пристроїв sysfs

Ядро призначає файли пристроям в тому порядку, в якому вони знайдені, тому пристрій може мати іншу назву між перезавантаженнями.

Ядро Linux пропонує інтерфейс `sysfs` через систему файлів і каталогів для забезпечення єдиного перегляду підключених пристроїв на основі їхніх фактичних апаратних атрибутів. Основним шляхом для пристроїв є `/sys/devices`.

![sysfs device entry](images/ls_sys_device.png)

У каталозі `/sys` є кілька ярликів. `/sys/block` має містити всі блокові пристрої, доступні в системі. Щоб знайти розташування `sysfs` пристрою в `/dev`, використовуйте команду `udevadm`:

`udevadm info --query=all --name=/dev/sda`

## `dd` і пристрої

Програма `dd` надзвичайно корисна під час роботи з блоковими та символьними пристроями, її функція полягає в читанні з вхідного файлу або потоку та записі у вихідний файл або потік (dd копіює дані в блоках фіксованого розміру).

Використання:
`dd if=/dev/zero of=new_file bs=1024 count=1`

## Імена пристроїв

Іноді буває важко знайти назву пристрою. Нижче наведено деякі поширені пристрої Linux і правила їх іменування:

### Жорсткі диски: `/dev/sd*`

Ці пристрої являють собою цілі диски; ядро створює окремі файли пристроїв, такі як `/dev/sda1` і `/dev/sda2`, для розділів на диску.

![Пристрої SCSI](images/lsscsi.png)

Частина назви sd означає диск `SCSI` (Small Computer System Interface). Щоб отримати список пристроїв SCSI у вашій системі, скористайтеся утилітою, яка переглядає шляхи пристроїв, надані sysfs.

Більшість сучасних систем Linux використовують універсальний унікальний ідентифікатор (`UUID`) для постійного доступу до дискового пристрою.

### Приводи CD і DVD: `/dev/sr*`

Пристрої `/dev/sr*` доступні в режимі read only, і вони використовуються лише для читання з дисків.

### Жорсткі диски PATA: `/dev/hd*`

Блокові пристрої Linux `/dev/hd*` є звичайними для старих версій ядра Linux і зі старішим апаратним забезпеченням.

### Термінали: `/dev/tty*`, `/dev/pts/*` і `/dev/tty`

Термінали — це пристрої для переміщення символів між процесом користувача та пристроєм введення/виведення, зазвичай для виведення тексту на екран термінала. Псевдотермінали — це емульовані термінали, які розуміють функції введення/виведення реальних терміналів.

Два поширені термінальні пристрої: `/dev/tty1` (перша віртуальна консоль) і `/dev/pts/0` (перший псевдотермінальний пристрій).

Пристрій `/dev/tty` є керуючим терміналом поточного процесу. Якщо програма зараз читає та записує на термінал, цей пристрій є синонімом цього терміналу. Процес не потрібно приєднувати до термінала.

Linux має два основних режими відображення: текстовий режим і сервер X Window System (графічний режим). Ви можете перемикатися між різними віртуальними середовищами за допомогою клавіш ctrl-alt-Function.

### Паралельні порти: `/dev/lp0` і `/dev/lp1`

Представляє тип інтерфейсу, який значною мірою був замінений новішим USB.

Ви можете надсилати файли (наприклад, файл для друку) безпосередньо на паралельний порт за допомогою команди `cat`.

### Аудіопристрої: `/dev/snd/*`, `/dev/dsp`, `/dev/audio` тощо

Linux має два набори аудіопристроїв. Існують окремі пристрої для системного інтерфейсу Advanced Linux Sound Architecture (ALSA в `/dev/snd`) і старішої Open Sound System (OSS).

### Створення файлу пристрою

Команда `mknod` створює один пристрій (вже вважається застарілим). Ви повинні знати назву пристрою, а також його основні та додаткові номери.

## `udev`

Ядро Linux може надсилати сповіщення спеціальному процесу простору користувача (під назвою `udevd`) після виявлення нового пристрою в системі.

Процес простору користувача на іншому кінці перевіряє характеристики нового пристрою, створює файл пристрою, а потім виконує будь-яку ініціалізацію пристрою.

### `devtmpfs`

Файлова система `devtmpfs` була розроблена у відповідь на проблему доступності пристрою під час завантаження. Ця файлова система схожа на старішу `devfs`, але вона спрощена.

За потреби ядро створює файли пристрою, але також сповіщає `udevd` про те, що новий пристрій доступний.

### `udevd` Робота та конфігурація

![udev event](images/udev_event.png)

Демон `udevd` працює таким чином:

1. Ядро надсилає `udevd` сповіщення, що називається `uevent`, через внутрішній канал мережі
2. `udevd` завантажує всі атрибути в `uevent`
3. `udevd` аналізує свої правила, і виконує дії або встановлює додаткові атрибути на основі цих правил

![udev rules](images/udev_rules.png)

![udev export](images/udev_export.png)

### `udevadm`

Програма `udevadm` є інструментом адміністрування `udevd`.

![udevadm](images/udevadm.png)

Ви можете перезавантажувати правила `udevd` і запускати події, але, мабуть, найпотужнішими функціями `udevadm` є можливість шукати та досліджувати системні пристрої та можливість відстежувати події `udevd`, коли `udevd` отримує їх від ядра.

### Пристрої моніторингу

Щоб контролювати `uevent`s за допомогою `udevadm`, використовуйте команду monitor: `udevadm monitor`

![udevadm monitor](images/udevadm_monitor.png)

## Поглиблено: `scsi` і ядро Linux

Традиційне обладнання SCSI — це адаптер хоста, з’єднаний із ланцюгом пристроїв через шину SCSI. Цей адаптер під’єднується до комп’ютера, хост-адаптер; пристрої мають ідентифікатор SCSI; на шину може бути 8 або 16 ідентифікаторів залежно від версії SCSI.

![Пристрої SCSI](images/Figure3-1.png)

Хост-адаптер спілкується з пристроями через набір команд SCSI в одноранговому зв’язку; пристрої надсилають відповіді назад до хост-адаптера.

Підсистему SCSI та її три рівні драйверів можна описати так:

- Верхній рівень обробляє операції для класу пристроїв
- Середній рівень модерує та направляє повідомлення SCSI між верхнім і нижнім рівнями, а також відстежує всі шини SCSI та пристрої, підключені до системи.
- Нижній рівень обробляє специфічні апаратні дії. Драйвери тут надсилають вихідні повідомлення протоколу SCSI до певних хост-адаптерів або апаратного забезпечення та витягують вхідні повідомлення з апаратного забезпечення

![Робота з пристроями SCSI](images/Figure3-2.png)

### USB накопичувач і SCSI

USB дуже схожий на SCSI — він має класи пристроїв, шини та хост-контролери.

Ядро Linux містить трирівневу підсистему USB, яка дуже нагадує підсистему SCSI, з драйверами класу пристроїв у верхній частині, ядром керування шиною посередині та драйверами хост-контролера внизу.

### SCSI та ATA

Щоб увімкнути драйвери SATA ядра до підсистеми SCSI, ядро використовує драйвер моста, як і з USB-накопичувачами.

Оптичний привід підтримує ATAPI, версію команд SCSI, закодовану в протоколі ATA.

![Множинний доступ до файлу пристрою](images/Figure3-3.png)
