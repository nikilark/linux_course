# Розділ 9: Як завантажується ядро Linux

```plaintext
<користувач> Чому мій Linux так швидко завантажується?
<адмін> Бо він не зупиняється, щоб запитати, чи ви впевнені, що хочете завантажитися. Він вважає, що ви вже готові страждати.
```

![Завантаження Linux](images/boot_process.webp)

Спрощено процес завантаження Linux виглядає так:

1. BIOS або завантажувальна мікропрограма завантажує та запускає завантажувач (_bootloader_)
2. _bootloader_ містить образ ядра на диску, завантажує його в пам'ять і запускає
3. Ядро ініціалізує пристрої та драйвери
4. Ядро монтує кореневу файлову систему
5. Ядро запускає програму під назвою _init_ з ідентифікатором процесу 1. Ця точка є запуском простору користувача
6. _init_ запускає решту системних процесів
7. У певний момент ініціалізації запускається процес, який дозволяє вам увійти, фактично наприкінці або ближче до кінця завантаження

## Повідомлення при запуску

```plaintext
<користувач> Мій Linux не завантажується, пише "Kernel panic: unable to mount root fs."
<адмін> Вітаю, ядро панікує раніше, ніж ви.
```

Є три способи переглянути діагностичні повідомлення ядра під час завантаження та виконання:

- Системний журнал за допомогою `journalctl -k`
- Файл системного журналу ядра в `/var/log/kern.log`
- Команда `dmesg` (використовуйте `less` для перегляду результату)

![Приклад виводу journalctl](images/journalctl_messages.png)

Повідомлення відбуваються спочатку від ядра, а потім від процесів і ініціалізації системи, які запускаються поступово. Однак вони не послідовні, а в деяких випадках навіть не особливо інформативні.

Крім того, апаратні вдосконалення привели до того, що тепер ядро запускається набагато швидше, ніж раніше, і повідомлення виводяться так швидко, що буває важко зрозуміти, що відбувається.

У результаті більшість сучасних дистрибутивів Linux роблять все можливе, щоб приховати діагностику завантаження за допомогою заставок і інших форм заповнення екрана, щоб відвернути вашу увагу під час запуску системи.

## Параметри ініціалізації ядра та Boot Options

Після запуску ядро Linux ініціалізується в такому загальному порядку:

- Перевірка ЦП
- Перевірка пам'яті
- Виявлення шини пристроїв
- Виявлення пристроїв
- Налаштування допоміжної підсистеми ядра (мережі тощо)
- Монтування кореневої файлової системи
- Запуск простору користувача

В цілому вам не потрібно перейматись залежностями, хоча деякі необхідні компоненти можуть бути завантажуваними модулями ядра, а не частиною основного ядра. Для деяких систем може знадобитися завантажити ці модулі ядра до того, як буде змонтована основна коренева файлова система.

Ядро видає певні види повідомлень, що вказують на те, що воно готове запустити свій перший процес користувача:

![Повідомлення про завершення ініціалізації ядра](images/boot1.png)

Тут воно не тільки очищає частину незалученої пам'яті, але і захищає власні дані. Потім, якщо ядро пройде достатньо кроків налаштування можна побачити, що ядро запускає перший процес у просторі користувача як _init_:

![Повідомлення про запуск init](images/boot2.png)

Після цього монтується коренева файлова система і запускається systemd (імплементація _init_), надсилаючи кілька власних повідомлень у журнал ядра:

![Повідомлення про запуск systemd](images/boot3.png)

На цьому етапі запущено простір користувача.

## Параметри ядра

Під час запуску ядра _bootloader_ Linux передає набір текстових параметрів ядра, які запускають ядро, як воно повинно запускатися. Ці параметри знаходяться в _/proc/cmdline_.

![Параметри ядра](images/cmdline.png)

Найважливішим параметром є параметр _root_, який є розташуванням кореневої файлової системи (без нього ядро не можна знайти, а також не можна виконати запуск простору користувача).

Зустрічаючи параметр, який не розуміє, ядро Linux його зберігає і пізніше передає параметр init під час запуску простору користувача.

## Завантажувачі

```plaintext
<користувач> Я зробив розділення вручну, але тепер система не завантажується.
<адмін> Куди ви встановили завантажувач?
<користувач> /dev/null
<адмін> ... Чудово.
```

Завантажувач запускає ядро з набором параметрів, які наявні десь у кореневій файловій системі.

Навіть якщо параметри ядра або драйвери диска не знайдено, завантаження можливе, бо майже все дискове обладнання має мікропрограму, яка дозволяє BIOS підтримувати доступ до підключеного сховища обладнання з логічною блоковою адресацією (_LBA_).

Як тільки отримано доступ до необроблених даних диска, завантажувач повинен знайти потрібні дані у файловій системі. Більшість сучасних завантажувачів можуть переглядати таблиці розділів і мають вбудовану підтримку доступу до файлових систем тільки для читання.

Таким чином, вони можуть шукати та читати файли, необхідні для завантаження ядра в пам'ять. Ця можливість значно покращує динамічне налаштування та удосконалює завантажувач.

### Завдання завантажувача

Основні функції завантажувача Linux включають наступні дії:

- Вибір серед кількох ядер
- Вибір набору параметрів ядра
- Дозвіл користувачеві вручну змінювати та редагувати назви та параметри образів ядра (наприклад перейти в однокористувацький режим)
- Забезпечення підтримки для завантаження інших операційних систем

## GRUB Вступ

GRUB (Grand Unified Boot Loader) є майже універсальним стандартом для системи Linux і має навігацію файловою системою, яка дозволяє швидше вибрати образ ядра та конфігурацію. GRUB насправді не використовує ядро Linux, він запускає його.

![Меню завантужавача GRUB](images/Figure5-1.png)

Щоб отримати доступ до меню GRUB, натисніть і утримуйте клавішу Shift при першому появі екрана запуску BIOS або ESC, якщо у вашій системі є UEFI. У протилежному випадку конфігурація завантажувача може не зупинятись перед завантаженням ядра.

![Редактор налаштувань GRUB](images/Figure5-2.png)

Безумовно, найбільша плутаниця виникає через використання _root_ в GRUB. Зазвичай _root_ застосовується для визначення кореневої файлової системи. У конфігурації GRUB це параметр ядра, розташований після імені образу команди linux.

Усі інші посилання на слово _root_ у конфігураціях позначають корінь GRUB, який існує лише всередині GRUB. Корень GRUB — це файлова система, в якій GRUB виконує пошук файлів образів файлової системи ядра та оперативної пам'яті.

## Дослідження пристроїв і розділів за допомогою командного рядка GRUB

```plaintext
<користувач> GRUB видав помилку: "Підтримується лише базове редагування, схоже на Bash."
<адмін> Ласкаво просимо до квест-кімнати для хакерів. Удачі.
```

GRUB має власну схему адресації пристроїв під назвою hdx, де x дорівнює 0,1... GRUB також має командний рядок (для цього можна отримати доступ, натиснувши `C` у меню завантаження), де ви можете ввести наступні команди:

- `ls -l`: команда переліку, деталізує список пристроїв, відомих grub
- `set`: поточних встановлених змінних grub
- `ls ($root)/`: показати інформацію про кореневий розділ
- `ls ($root)/boot`: відображає інформацію про розділ завантаження

![Вивід команди ls -l](images/grub_ls.png)

![Вивід команди set](images/grub_set.png)

Однією з найважливіших змінних є `$prefix` — файлова система та каталог, у яких GRUB має необхідну конфігурацію та допоміжні утиліти.

## Конфігурація GRUB

Каталог конфігурації GRUB містить центральний файл конфігурації (_grub.cfg_) і численні завантажувані модулі з суфіксом _.mod_. Загальний це каталог _/boot/grub_ або _/boot/grub2_. Використовуйте команду _grub-mkconfig_, щоб змінити цей файл.

### Перегляд Grub.cfg

Файл _grub.cfg_ складається з команди GRUB, яка зазвичай починається з кількох кроків ініціалізації, за якими слідує ряд пунктів меню для різних конфігурацій ядра та завантаження. В цьому файлі ви побачите доступні конфігурації завантажень, які починаються з команди _menuentry_.

![Приклад конфігурації GRUB](images/grub_cfg.png)

![Приклад menuentry](images/grub_cfg_menuentry.png)

### Створення нового файлу конфігурації

Щоб внести зміни у вашу конфігурацію GRUB, додайте нову конфігурацію в інше місце, а потім запустіть `grub-mkconfig`, щоб створити нову конфігурацію. Кожен файл у _/etc/grub.d_ є сценарієм, який створює частину файлу _grub.cfg_. Сама команда `grub-mkconfig` є сценарієм, який запускає все в _/etc/grub.d_.

## Встановлення GRUB

### Встановлення GRUB у вашій системі

GRUB постачається з утилітою під назвою _grub-install_, яка виконує більшу частину роботи з інстальованими файлами GRUB і налаштуваннями для вас.

### Встановлення GRUB на зовнішній накопичувач

Щоб інсталювати GRUB на пристрої зберігання даних за межами поточної системи, вам потрібно вручну вказати каталог GRUB на цьому пристрої так, як його бачить поточна система: `grub-install --boot-directory=<origin> <target>`

### Встановлення GRUB з UEFI

```plaintext
<користувач> Мій BIOS не може знайти GRUB.
<адмін> GRUB грає в хованки. Спробуйте пошукати в `/boot/efi/` або викличте його жертвопринесенням конфіг-файлу.
```

Встановлення UEFI має бути простим -- все, що вам потрібно зробити, це скопіювати завантажувач у потрібне місце. Але вам також потрібно показати завантажувач для мікропрограм за допомогою команди _efibootmgr_: `grub-install --efi-directory=efi_dir –-bootloader-id=name`

## Ланцюгове завантаження інших операційних систем

```plaintext
<користувач> Я встановив Linux поруч із Windows, але тепер не можу завантажити Windows.
<адмін> GRUB її з'їв.
<користувач> Чи можна її повернути?
<адмін> Звісно, але GRUB спочатку має все переварити.
```

UEFI окремо підтримує завантаження інших операційних систем, якщо ви захочете інсталювати кілька завантажувачів у розділі EFI, але старіша MBR не підтримується.

![Приклад завантаження іншої операційної системи](images/menuentry.png)

## Деталі завантажувача

### Завантаження MBR

Основний завантажувальний запис (MBR) містить небагато пам'яті (441 байт), BIOS ПК завантажується та запускає код в ньому після самоперевірки під час увімкнення (Power-On Self-Test -- POST).

Але часто потрібен додатковий простір, тому використовується багатоетапний завантажувач (MBR не робить нічого, крім завантаження решти коду завантажувача).

### Завантаження UEFI

Розширений інтерфейс вбудованого програмного забезпечення (The Extensible Firmware Interface -- EFI), поточним стандартом якого є Unified EFI (UEFI), складається зі спеціальної файлової системи, що називається системним розділом EFI (EFI System Partition ESP), який містить каталог під назвою _efi_. Кожен завантажувач має ідентифікатор власника та відповідний підкаталог. Файл завантажувача має розширення _.efi_ та знаходиться в одному з цих підкаталогів разом з іншими допоміжними файлами.

### Як працює GRUB

Таким чином, GRUB робить наступне:

1. BIOS комп’ютера або мікропрограма ініціалізує апаратне забезпечення та шукає код для завантаження на пристроях в порядку boot-order
2. Знайшовши код для завантаження, BIOS/мікропрограма завантажує та виконує його. Тут починається GRUB
3. Завантажується ядро GRUB
4. Ядро ініціалізується. На цьому етапі GRUB тепер може отримати доступ до дисків і файлової системи
5. GRUB визначає завантажувальний розділ і завантажує туди конфігурацію
6. GRUB надає користувачам можливість змінювати конфігурацію
7. Після тайм-ауту або дії користувача GRUB виконується конфігурація
8. Під час виконання конфігурації GRUB можна завантажити додатковий код (модулі) у завантажувальний розділ
9. GRUB виконує команду завантаження, щоб завантажити та виконати ядро, як вказано у конфігурації Linux
